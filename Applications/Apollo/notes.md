## Supergraph
Supergraph is created in terraform/<cloud provider>/create_graph.sh

this will create an api request to create your new graph and try to link the subgraph schema using rover 

### Persisted Queries
it ALSO tries to set up persisted queries, which I'm not 100% sure what these do yet

## Subgraphs
in the actual reference architecture, when the helm chart for the subgraphs are deployed, it also kicks of a Rover task to publish the subgraphs to the apollo enterprise instance
this is also where I found the expected routing for all of the subgraphs. We're actually going to change this (http://graphql.${{ inputs.subgraph_name }}.svc.cluster.local:4001) to use the same apollo namespace for everything. Just to keep things concise. Will be on the lookout for any abnormalities with this. 

I also had to change some of the names and labels of the deployments and services in order to prevent colissions since I changed them to be in the same namespace

### Manual steps to automate
#### deploy with Rover
```bash
rover subgraph publish ${APOLLO_GRAPH_ID}@${VARIANT} \
  --name ${SUBGRAPH_NAME} \
  --routing-url http://${SUBGRAPH_NAME}.apollo.svc.cluster.local:4001/graphql \
  --schema ./subgraphs/${{SUBGRAPH_NAME}}/schema.graphql \
```

#### Deploy Client persisted queries manifest
Don't know what this is yet, but it happens on the PR merge (subgraph build) as well as subgraph deploy

but generating this can be done with this NPM package https://www.npmjs.com/package/@apollo/generate-persisted-query-manifest
running in the client folder

and then published with rover
```bash
rover persisted-queries publish ${APOLLO_GRAPH_ID}@${VARIANT} \
    --manifest <the json manifest generated by the NPM package above>
```

I was able to generate the manifest but publishing it requires an Enterprise account

### Questions
- Why do the schemas get published both at build time as well as deploy? 
- what are persisted queries https://www.apollographql.com/docs/kotlin/advanced/persisted-queries

## Router and Coprocessor
~had to also add some custom fields to the helm chart to get it to play nicely with my ingress classes and cert manager~

I actually ended up using the official helm chart for the Router, because the one in the example arch was a little bit lacking and made a lot of assumptions about you using cloud providerrs. 
I also used the "extraContainers" values option to deploy the coprocessor as a sidecar. 

This also doesn't configure the Rhai scripts config map for you, but you can still pas in an existing config map into this helm chart.

## Client
had to edit the ingress template to support TLS and ingress className fields but other than that it looks fine

